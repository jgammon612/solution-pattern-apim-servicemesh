<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Enable API Management for bookinfo :: Solution Patterns for Cloud Native Architectures</title>
    <link rel="canonical" href="https://redhat-solution-patterns.github.io/solution-patterns/comprehensive-service-architecture/4/06-enable-api-mgmt-bookinfo.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const clusterName = urlParams.get('CLUSTER_WILDCARD_URL');
      const projectName = urlParams.get('PROJECT');
      if (clusterName) {
        showCluster( clusterName );
      }
      else {
        showClusterForm();
      }

      if (projectName) {
        showProject( projectName );
      } else {
        showProjectForm();
      }
    } );


    function sliceCluster(clusterName){
      if (clusterName.length > 70) {
          return "..." + clusterName.slice(35);
      } else {
          return clusterName;
      }
    }

    function showCluster( clusterName ) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('cluster_subdomain').textContent = sliceCluster(clusterName);
      document.getElementById('clusterfield2').value = clusterName;

    }

    function showClusterForm( clusterName ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
    }

    function gowithcluster() {
      elClusterInput = document.getElementById('clusterfield');
      elProjectInput = document.getElementById('projectfield2');

      // Remove Project from URL query parameters
      window.location.search = ('&CLUSTER_WILDCARD_URL=' + elClusterInput.value);
      // window.location.search = ('&CLUSTER_WILDCARD_URL=' + elClusterInput.value + '&PROJECT=' + elProjectInput.value);
    }

    function showProject( projectName ) {
      document.getElementById('navbar-form-project-empty').style.display = "none";
      document.getElementById('navbar-form-project-filled').style.display = "flex";
      document.getElementById('project').textContent = projectName;
      document.getElementById('projectfield2').value = projectName;
    }

    function showProjectForm( projectName ) {
      document.getElementById('navbar-form-project-empty').style.display = "flex";
      document.getElementById('navbar-form-project-filled').style.display = "none";
    }

    function gowithproject() {
      elProjectInput = document.getElementById('projectfield');
      elClusterInput = document.getElementById('clusterfield2');
      window.location.search = ('&CLUSTER_WILDCARD_URL=' + elClusterInput.value + '&PROJECT=' + elProjectInput.value);
    }

  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://redhat-solution-patterns.github.io/" target="_blank"><img
          src="https://redhat-solution-patterns.github.io/solution-pattern-enhancing-applications/_/img/logo.png" height="40px" alt="Solution Patterns"></a>
      <a class="navbar-item" style="font-size: 14px; color: white" href="https://redhat-solution-patterns.github.io/solution-patterns">Solution Patterns for Cloud Native Architectures</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item" id="navbar-form-empty">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>

          <form action="javascript:void(0);" onsubmit="gowithcluster();">
            <input size="40" id="clusterfield" type="text" placeholder="Enter the OpenShift ingress domain value">
            <input type="hidden" id="projectfield2" name="projectfield2" value="">
          </form>
        </div>

        <div class="navbar-item" id="navbar-form-filled" style="display: none;">
          <span class="navbar-text" id="cluster_subdomain"></span>
        </div>

         <div class="navbar-item" id="navbar-form-project-empty">
          <!-- Removing the Project text field and exclamation triangle -->
          <!-- <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span> -->

          <form action="javascript:void(0);" onsubmit="gowithproject();">
            <!-- <input size="40" id="projectfield" type="text" placeholder="Enter Project Name"> -->
            <input type="hidden" id="clusterfield2" name="clusterfield2" value="">
          </form>
        </div>

        <div class="navbar-item" id="navbar-form-project-filled" style="display: none;">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
          <span class="navbar-text" id="project"></span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i></span>
        </div>

        
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Solution Patterns</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://red.ht/enhance-with-cdc" target="_blank">Adopt Change Data Capture for stack modernization</a>
            <a class="navbar-item" href="https://red.ht/enhance-with-eda" target="_blank">Enhancing Applications with Application Services</a>
          </div>
      </div>
      <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Other</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-gitops-patterns.io/" target="_blank">GitOps Solution Patterns</a>
            <a class="navbar-item" href="https://hybrid-cloud-patterns.io/" target="_blank">Hybrid Cloud Solution Patterns</a>
          </div>
      </div>
      <a class="navbar-item" href="https://www.redhat.com/en/products/middleware" target="_blank">Red Hat Application Services</a>
      <a class="navbar-item" href="https://developers.redhat.com/middleware" target="_blank">Learn more</a>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="comprehensive-service-architecture" data-version="4">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Comprehensive Service Architecture</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">1. Home page</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#use-cases">1.1 Use cases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_story_behind_this_solution_pattern">1.2 The story behind this solution pattern</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_solution">1.3 The solution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-architecture.html">2. Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#_common_challenges">2.1. Common Challenges</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#tech_stack">2.2. Technology stack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#in_depth">2.3. An in-depth look at the solution&#8217;s architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html">3. See the Solution in Action</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-demo.html#_demonstration">3.1. Demonstration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html#_run_the_demonstration">3.2. Run this demonstration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-demo.html#_before_getting_started">3.3. Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-demo.html#_installing_the_demo">3.4. Installing the demo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-demo.html#_walkthrough_guide">3.5. Walkthrough guide</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://redhat-solution-patterns.github.io/">4. Other Red Hat Solution Patterns</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Comprehensive Service Architecture</span>
    <span class="version">4</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Comprehensive Service Architecture</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">4</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Comprehensive Service Architecture</a></li>
    <li><a href="06-enable-api-mgmt-bookinfo.html">Enable API Management for bookinfo</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-servicemesh-apim-demo/rh-apim-servicemesh-solution-pattern-test/edit/master/documentation/modules/ROOT/pages/06-enable-api-mgmt-bookinfo.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Enable API Management for bookinfo</h1>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we shall enable the API management for bookinfo application using the 3scale WASM module</p>
</div>
<div class="sect2">
<h3 id="service-entry"><a class="anchor" href="#service-entry"></a>Create Service Entry</h3>
<div class="paragraph">
<p>To have the 3scale Web Assembly module authorize requests against 3scale, the module must have access to 3scale services. You can accomplish this within Red Hat OpenShift Service Mesh and Istio by applying an external ServiceEntry object.</p>
</div>
<div class="paragraph">
<p>The custom resources set up the service entries for access from within Service Mesh to 3scale for the backend and system components of the Service Management API and the Account Management API. The Service Management API receives queries for the authorization status of each request. The Account Management API provides API management configuration settings for your services.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a Custom Resource Definition file for the System Service Entry with name <code>ServiceEntry_system-entry.yaml</code> using vim or any other editor on the CLI. Copy paste the below yaml into the file and save it.</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
 name: system-entry
spec:
 hosts:
   - system-provider.3scale.svc.cluster.local
 location: MESH_EXTERNAL
 ports:
   - name: http
     number: 3000
     protocol: HTTP
 resolution: DNS</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Custom Resource Definition file for the Backend Service Entry with name <code>ServiceEntry_backend-entry.yaml</code> using vim or any other editor on the CLI. Copy paste the below yaml into the file and save it.</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
 name: backend-entry
spec:
 hosts:
   - backend-listener.3scale.svc.cluster.local
 location: MESH_EXTERNAL
 ports:
   - name: http
     number: 3000
     protocol: HTTP
 resolution: DNS</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the CRDs to your cluster using the below command</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ServiceEntry_system-entry.yaml -f ServiceEntry_backend-entry.yaml -n bookinfo</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="service-mesh-extension"><a class="anchor" href="#service-mesh-extension"></a>Create Service Mesh Extension</h3>
<div class="paragraph">
<p>The ServiceMeshExtension custom resource spec provides the configuration that the Proxy-WASM module reads from. The spec is embedded in the host and read by the Proxy-WASM module. Follow the below steps to configure the  ServiceMeshExtension</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you haven&#8217;t already noted down the 'Admin Access Token' from 3scale Secret from earlier labs please follow these steps.   Retrieve the <strong>Admin_Access_token</strong> using the Console UI. Select 3scale project and Navigate to Developer &gt; Secrets and search for <strong>system-seed</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/seed-nav.png" alt="seed nav">
</div>
</div>
</li>
<li>
<p>From the <strong>system-seed</strong> secret just copy and note down the the <strong>Admin_Access_Token</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/admin-cred.png" alt="admin cred">
</div>
</div>
</li>
<li>
<p>The service token will enable the permission for service mesh to be able to access a particular 3scale product. From the 3scale admin-portal navigate to  Account Settings &gt; Personal &gt; Tokens and Copy the Service Token of the product we created earlier</p>
<div class="imageblock">
<div class="content">
<img src="_images/service-token-ui.png" alt="service token ui">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Alternatively, you can also use 3scale <strong>admin access token</strong> along with the 3scale <strong>product ID</strong> from the 3scale product configuration earlier and run the following command with values <strong>replaced</strong> to obtain the Service token:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl <a href="https://3scale-admin.%CLUSTER_WILDCARD_URL%/admin/api/services/{product" class="bare">https://3scale-admin.%CLUSTER_WILDCARD_URL%/admin/api/services/{product</a> id}/proxy/configs/production/latest.json?access_token={access token} | jq '.proxy_config.content.backend_authentication_value'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy and note down the Service Access Token obtained</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a Custom Resource Definition file for the Service Mesh Extension with name <code>ServiceMeshExtension_bookinfo.yaml</code> using vim or any other editor on the CLI. Copy paste the below yaml into the file and replace the <strong>access token</strong>, <strong>service token</strong>, <strong>product id</strong> values as shown in the image below and save it.</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: maistra.io/v1
kind: ServiceMeshExtension
metadata:
 name: bookinfo
spec:
 image: 'registry.redhat.io/openshift-service-mesh/3scale-auth-wasm-rhel8:0.0.1'
 phase: PostAuthZ
 priority: 100
 workloadSelector:
   labels:
     app: productpage
 config:
   api: v1
   system:
     name: system
     token: VDG2U6c9kXwdetUH
     upstream:
       name: &gt;-
         outbound|3000||system-provider.3scale.svc.cluster.local
       timeout: 5000
       url: 'http://system-provider.3scale.svc.cluster.local'
   backend:
     extensions:
       - no_body
     name: backend
     upstream:
       name: &gt;-
         outbound|3000||backend-listener.3scale.svc.cluster.local
       timeout: 5000
       url: 'http://backend-listener.3scale.svc.cluster.local'
   services:
     - id: '3'
       token: cf939c57f946bb3c809508caabeac45db51782f1c671e4a2dd2dad57d29ba394
       authorities:
         - '*'
       credentials:
         app_id:
           - header:
               keys:
                 - app_id
           - query_string:
               keys:
                 - app_id
         app_key:
           - header:
               keys:
                 - app_key
           - query_string:
               keys:
                 - app_key
         user_key:
           - query_string:
               keys:
                 - user_key
           - header:
               keys:
                 - user_key
       mapping_rules:
         - method: GET
           pattern: /
           usages:
             - delta: 1
               name: hits</code></pre>
</div>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="terminal-guide.png" alt="terminal guide">
</div>
</div>
</li>
<li>
<p>Apply the CRD to your cluster using the below command</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ServiceMeshExtension_bookinfo.yaml -n bookinfo</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have now successfully manged the API with 3scale. Next we have to authorize an application to acess this API</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="application-authorise"><a class="anchor" href="#application-authorise"></a>Authorize an application to consume the API managed</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Login to 3scale and navigate to Products &gt; wasm-demo &gt; Applications &gt; Listing and Click <strong>Create Application</strong></p>
<div class="imageblock unresolved">
<div class="content">
<img src="create-app.png" alt="create app">
</div>
</div>
</li>
<li>
<p>Choose the default Developer Account, wasm-basic as Application Plan. Give any name and description to the application. Click on <strong>Create Application</strong></p>
<div class="imageblock unresolved">
<div class="content">
<img src="app-details.png" alt="app details">
</div>
</div>
</li>
<li>
<p>You should now have an API user key that you can copy and use for authorization</p>
<div class="imageblock unresolved">
<div class="content">
<img src="api_key.png" alt="api key">
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="verification"><a class="anchor" href="#verification"></a>Verifying the policy enforcement</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can now verify the policy enforcement by first calling the endpoint without credentials and then later using the api key.</p>
</li>
<li>
<p>Open a browser window and navigate to:</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-weblink hljs" data-lang="weblink"><a href="https://reqbin.com/curl" class="bare">https://reqbin.com/curl</a></code></pre>
</div>
</div>
</li>
<li>
<p>Copy and paste the below command.</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -v <a href="http://istio-ingressgateway-istio-system.%CLUSTER_WILDCARD_URL%/productpage" class="bare">http://istio-ingressgateway-istio-system.%CLUSTER_WILDCARD_URL%/productpage</a></code></pre>
</div>
</div>
</li>
<li>
<p>You should see a 403 status and we have not provided an api user key.</p>
<div class="imageblock unresolved">
<div class="content">
<img src="403.png" alt="403">
</div>
</div>
</li>
<li>
<p>Now let&#8217;s append the api key and see what happens. Copy and paste the below command in reqbin. Do not forget to Replace the <strong>userkey</strong>.</p>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -v <a href="http://istio-ingressgateway-istio-system.%CLUSTER_WILDCARD_URL%/productpage?user_key={user" class="bare">http://istio-ingressgateway-istio-system.%CLUSTER_WILDCARD_URL%/productpage?user_key={user</a> key}</code></pre>
</div>
</div>
</li>
<li>
<p>You API call should be successful and should show a 200 HTTP response. If you make more than 8 calls per minute (recollect the limit we set in our application plans) you should see a 403 status. The count gets refreshed every minute</p>
<div class="imageblock unresolved">
<div class="content">
<img src="200.png" alt="200">
</div>
</div>
</li>
<li>
<p>In case you want to verify the calls on Kiali and Jaeger you can send multiple calls via reqbin and check the paths and traces on the Kiali and Jaeger interfaces as illustrated earlier.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <img
          src="../../_/img/app-services-logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns"  href="https://redhat.com" ></a>
</footer><script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
